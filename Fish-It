-- Fish It! Webhook Notification Script (Game ID: 121864768012064)
-- Compatible with Delta Executor
-- [DIPERBAIKI TOTAL] - Error "vulnerable function" + Bug GUI + Fitur Input Manual

local Players = game:GetService("Players")
local HttpService = game:GetService("HttpService")
local StarterGui = game:GetService("StarterGui")
local TweenService = game:GetService("TweenService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

local player = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")

-- Configuration
local CONFIG = {
    WEBHOOK_URL = "", -- Biarkan kosong untuk input manual
    ENABLED = true,
    SHOW_GUI = true,
    NOTIFICATION_DURATION = 5,
    RARE_FISH_ONLY = false,
    SECRET_FISH_ONLY = false,
    RARE_FISH_LIST = {
        "Shark", "Megalodon", "Monster Shark", "Eerie Shark", "Thin Armor Shark",
        "Mythic Shark", "Secret", "Golden", "Diamond", "Crystal", "Legendary",
        "Epic", "Rare", "Rainbow", "Neon", "Glowing", "Ancient"
    },
    SECRET_FISH_LIST = {
        "Monster Shark", "Eerie Shark", "Secret", "Mythic"
    }
}

-- Fungsi untuk menyimpan Webhook URL
local function saveWebhookURL(inputText)
    if not inputText or inputText == "" then
        StarterGui:SetCore("SendNotification", {
            Title = "‚ùå Error";
            Text = "URL tidak boleh kosong!";
            Duration = 4;
        })
        return false
    end

    -- Validasi format dasar Discord Webhook
    if not inputText:find("^https://discord.com/api/webhooks/%d+/[%w_-]+$") then
        StarterGui:SetCore("SendNotification", {
            Title = "‚ùå Error";
            Text = "Format URL Webhook Discord tidak valid!";
            Duration = 5;
        })
        return false
    end

    CONFIG.WEBHOOK_URL = inputText

    -- Update GUI
    if _G.FishItGUI and _G.FishItGUI.webhookLabel then
        _G.FishItGUI.webhookLabel.Text = "üì° Webhook: ‚úÖ Terhubung"
        _G.FishItGUI.webhookLabel.TextColor3 = Color3.fromRGB(80, 255, 80)
    end

    StarterGui:SetCore("SendNotification", {
        Title = "‚úÖ Sukses";
        Text = "Webhook URL berhasil disimpan!";
        Duration = 3;
    })

    print("‚úÖ Webhook URL diperbarui:", CONFIG.WEBHOOK_URL)
    return true
end

-- Fungsi Kirim Webhook (Diperbaiki untuk hindari error "vulnerable function")
local function sendWebhook(fishData)
    if not CONFIG.WEBHOOK_URL or CONFIG.WEBHOOK_URL == "" then
        warn("‚ùå Webhook URL belum diatur!")
        return false
    end

    -- Pastikan semua data aman (tidak mengandung kode berbahaya)
    local safeFishName = tostring(fishData.name or "Unknown Fish"):gsub("[^%w%s%p]", "")
    local safeRarity = tostring(fishData.rarity or "Common"):gsub("[^%w%s%p]", "")
    local safeLocation = tostring(fishData.location or "Unknown Area"):gsub("[^%w%s%p]", "")
    local safeRod = tostring(fishData.rod or "Basic Rod"):gsub("[^%w%s%p]", "")
    local safeTimestamp = tostring(fishData.timestamp):gsub("[^%w%s%p:/%-%.]", "")

    local rarityColor = {
        ["Common"] = 3447003,    -- Blue
        ["Rare"] = 15844367,     -- Gold
        ["Epic"] = 10181046,     -- Purple
        ["Legendary"] = 15105570,-- Orange
        ["Mythic"] = 16711680,   -- Red
        ["Secret"] = 65535,      -- Cyan
        ["Shark"] = 16711680     -- Red
    }

    local embedColor = rarityColor[safeRarity] or 3447003

    -- Gunakan URL gambar yang valid dan aman
    local thumbnailUrl = "https://tr.rbxcdn.com/4e5d3b4f5a5e5a5e5a5e5a5e5a5e5a5e/420/420/AvatarHeadshot/Png"
    local avatarUrl = "https://tr.rbxcdn.com/4e5d3b4f5a5e5a5e5a5e5a5e5a5e5a5e/420/420/AvatarHeadshot/Png"

    local embed = {
        title = "üé£ Fish Caught in Fish It!",
        description = string.format("**%s** berhasil menangkap ikan di Fish It! üêü", player.Name),
        color = embedColor,
        fields = {
            {
                name = "üêü Nama Ikan",
                value = safeFishName,
                inline = true
            },
            {
                name = "‚≠ê Rarity",
                value = safeRarity,
                inline = true
            },
            {
                name = "üìç Lokasi",
                value = safeLocation,
                inline = true
            },
            {
                name = "üé£ Rod",
                value = safeRod,
                inline = true
            },
            {
                name = "‚è∞ Waktu",
                value = safeTimestamp,
                inline = true
            }
        },
        thumbnail = {
            url = thumbnailUrl -- URL aman tanpa spasi
        },
        footer = {
            text = "Fish It! Webhook ‚Ä¢ Game ID: 121864768012064",
            icon_url = avatarUrl -- URL aman tanpa spasi
        },
        timestamp = os.date("!%Y-%m-%dT%H:%M:%S.000Z")
    }

    -- Special embed for rare/secret fish
    if safeRarity == "Secret" or safeRarity == "Mythic" or safeFishName:lower():find("shark") then
        embed.title = "ü¶à RARE FISH ALERT! ü¶à"
        embed.description = string.format("**%s** menangkap ikan LANGKA: **%s**! üåü", player.Name, safeFishName)
    end

    local data = {
        username = "Fish It! Bot üêü",
        avatar_url = avatarUrl, -- URL aman
        embeds = {embed}
    }

    local success, response = pcall(function()
        return HttpService:PostAsync(CONFIG.WEBHOOK_URL, HttpService:JSONEncode(data))
    end)

    if success then
        print("‚úÖ Webhook berhasil dikirim!")
        return true
    else
        warn("‚ùå Gagal mengirim webhook:", tostring(response))
        StarterGui:SetCore("SendNotification", {
            Title = "‚ùå Webhook Gagal";
            Text = "Periksa URL atau koneksi Anda.";
            Duration = 5;
        })
        return false
    end
end

-- GUI Creation
local function createModernGUI()
    local screenGui = Instance.new("ScreenGui")
    screenGui.Name = "FishItWebhook"
    screenGui.Parent = playerGui
    screenGui.ResetOnSpawn = false
    screenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling

    local mainFrame = Instance.new("Frame")
    mainFrame.Size = UDim2.new(0, 420, 0, 420)
    mainFrame.Position = UDim2.new(0.5, -210, 0.5, -210)
    mainFrame.BackgroundColor3 = Color3.fromRGB(15, 25, 40)
    mainFrame.BorderSizePixel = 0
    mainFrame.ZIndex = 10
    mainFrame.Parent = screenGui

    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 18)
    corner.Parent = mainFrame

    -- Title Bar
    local titleBar = Instance.new("Frame")
    titleBar.Size = UDim2.new(1, 0, 0, 60)
    titleBar.BackgroundColor3 = Color3.fromRGB(25, 50, 85)
    titleBar.ZIndex = 11
    titleBar.Parent = mainFrame

    local title = Instance.new("TextLabel")
    title.Text = "üêü Fish It! Webhook ü¶à"
    title.Size = UDim2.new(1, -120, 1, 0)
    title.Position = UDim2.new(0, 20, 0, 0)
    title.BackgroundTransparency = 1
    title.TextColor3 = Color3.fromRGB(255, 255, 255)
    title.Font = Enum.Font.GothamBold
    title.TextXAlignment = Enum.TextXAlignment.Left
    title.ZIndex = 12
    title.Parent = titleBar

    -- Close Button
    local closeBtn = Instance.new("TextButton")
    closeBtn.Text = "‚úï"
    closeBtn.Size = UDim2.new(0, 35, 0, 35)
    closeBtn.Position = UDim2.new(1, -45, 0, 12)
    closeBtn.BackgroundColor3 = Color3.fromRGB(220, 50, 50)
    closeBtn.BorderSizePixel = 0
    closeBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
    closeBtn.Font = Enum.Font.GothamBold
    closeBtn.ZIndex = 12
    closeBtn.Parent = titleBar

    -- Status Frame
    local statusFrame = Instance.new("Frame")
    statusFrame.Size = UDim2.new(1, -20, 0, 90)
    statusFrame.Position = UDim2.new(0, 10, 0, 70)
    statusFrame.BackgroundColor3 = Color3.fromRGB(20, 35, 60)
    statusFrame.ZIndex = 11
    statusFrame.Parent = mainFrame

    local statusLabel = Instance.new("TextLabel")
    statusLabel.Text = "Status: " .. (CONFIG.ENABLED and "üü¢ Aktif" or "üî¥ Nonaktif")
    statusLabel.Size = UDim2.new(1, -20, 0, 25)
    statusLabel.Position = UDim2.new(0, 10, 0, 10)
    statusLabel.BackgroundTransparency = 1
    statusLabel.TextColor3 = CONFIG.ENABLED and Color3.fromRGB(80, 255, 80) or Color3.fromRGB(255, 80, 80)
    statusLabel.Font = Enum.Font.Gotham
    statusLabel.ZIndex = 12
    statusLabel.Parent = statusFrame

    local fishCountLabel = Instance.new("TextLabel")
    fishCountLabel.Text = "üêü Ikan Tertangkap: 0"
    fishCountLabel.Size = UDim2.new(1, -20, 0, 25)
    fishCountLabel.Position = UDim2.new(0, 10, 0, 35)
    fishCountLabel.BackgroundTransparency = 1
    fishCountLabel.TextColor3 = Color3.fromRGB(100, 200, 255)
    fishCountLabel.Font = Enum.Font.Gotham
    fishCountLabel.ZIndex = 12
    fishCountLabel.Parent = statusFrame

    local webhookLabel = Instance.new("TextLabel")
    webhookLabel.Text = "üì° Webhook: " .. (CONFIG.WEBHOOK_URL ~= "" and "‚úÖ Terhubung" or "‚ùå Belum Diatur")
    webhookLabel.Size = UDim2.new(1, -20, 0, 25)
    webhookLabel.Position = UDim2.new(0, 10, 0, 60)
    webhookLabel.BackgroundTransparency = 1
    webhookLabel.TextColor3 = CONFIG.WEBHOOK_URL ~= "" and Color3.fromRGB(80, 255, 80) or Color3.fromRGB(255, 180, 80)
    webhookLabel.Font = Enum.Font.Gotham
    webhookLabel.ZIndex = 12
    webhookLabel.Parent = statusFrame

    -- Webhook Input
    local webhookInputFrame = Instance.new("Frame")
    webhookInputFrame.Size = UDim2.new(1, -20, 0, 60)
    webhookInputFrame.Position = UDim2.new(0, 10, 0, 170)
    webhookInputFrame.BackgroundColor3 = Color3.fromRGB(25, 40, 65)
    webhookInputFrame.ZIndex = 11
    webhookInputFrame.Parent = mainFrame

    local inputLabel = Instance.new("TextLabel")
    inputLabel.Text = "üîó Masukkan Webhook URL:"
    inputLabel.Size = UDim2.new(1, -10, 0, 20)
    inputLabel.Position = UDim2.new(0, 5, 0, 5)
    inputLabel.BackgroundTransparency = 1
    inputLabel.TextColor3 = Color3.fromRGB(220, 220, 255)
    inputLabel.Font = Enum.Font.Gotham
    inputLabel.ZIndex = 12
    inputLabel.Parent = webhookInputFrame

    local webhookInput = Instance.new("TextBox")
    webhookInput.Text = CONFIG.WEBHOOK_URL
    webhookInput.PlaceholderText = "https://discord.com/api/webhooks/..."
    webhookInput.Size = UDim2.new(1, -10, 0, 25)
    webhookInput.Position = UDim2.new(0, 5, 0, 30)
    webhookInput.BackgroundColor3 = Color3.fromRGB(35, 50, 75)
    webhookInput.TextColor3 = Color3.fromRGB(255, 255, 255)
    webhookInput.Font = Enum.Font.Gotham
    webhookInput.ClearTextOnFocus = false
    webhookInput.ZIndex = 13
    webhookInput.Parent = webhookInputFrame

    -- Control Buttons
    local buttonFrame = Instance.new("Frame")
    buttonFrame.Size = UDim2.new(1, -20, 0, 100)
    buttonFrame.Position = UDim2.new(0, 10, 0, 240)
    buttonFrame.BackgroundTransparency = 1
    buttonFrame.ZIndex = 11
    buttonFrame.Parent = mainFrame

    local toggleBtn = Instance.new("TextButton")
    toggleBtn.Text = CONFIG.ENABLED and "‚è∏Ô∏è Matikan" or "‚ñ∂Ô∏è Aktifkan"
    toggleBtn.Size = UDim2.new(0.48, 0, 0, 45)
    toggleBtn.BackgroundColor3 = CONFIG.ENABLED and Color3.fromRGB(255, 100, 100) or Color3.fromRGB(100, 255, 100)
    toggleBtn.BorderSizePixel = 0
    toggleBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
    toggleBtn.Font = Enum.Font.GothamBold
    toggleBtn.ZIndex = 12
    toggleBtn.Parent = buttonFrame

    local testBtn = Instance.new("TextButton")
    testBtn.Text = "üß™ Test Webhook"
    testBtn.Size = UDim2.new(0.48, 0, 0, 45)
    testBtn.Position = UDim2.new(0.52, 0, 0, 0)
    testBtn.BackgroundColor3 = Color3.fromRGB(100, 150, 255)
    testBtn.BorderSizePixel = 0
    testBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
    testBtn.Font = Enum.Font.GothamBold
    testBtn.ZIndex = 12
    testBtn.Parent = buttonFrame

    local rareToggle = Instance.new("TextButton")
    rareToggle.Text = "ü¶à " .. (CONFIG.RARE_FISH_ONLY and "Semua Ikan" or "Hanya Rare/Shark")
    rareToggle.Size = UDim2.new(1, 0, 0, 40)
    rareToggle.Position = UDim2.new(0, 0, 0, 55)
    rareToggle.BackgroundColor3 = CONFIG.RARE_FISH_ONLY and Color3.fromRGB(255, 165, 0) or Color3.fromRGB(70, 130, 180)
    rareToggle.BorderSizePixel = 0
    rareToggle.TextColor3 = Color3.fromRGB(255, 255, 255)
    rareToggle.Font = Enum.Font.GothamBold
    rareToggle.ZIndex = 12
    rareToggle.Parent = buttonFrame

    -- Save Button
    local saveWebhookBtn = Instance.new("TextButton")
    saveWebhookBtn.Text = "üíæ Simpan Webhook"
    saveWebhookBtn.Size = UDim2.new(0, 150, 0, 35)
    saveWebhookBtn.Position = UDim2.new(0.5, -75, 0, 350)
    saveWebhookBtn.BackgroundColor3 = Color3.fromRGB(70, 180, 100)
    saveWebhookBtn.BorderSizePixel = 0
    saveWebhookBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
    saveWebhookBtn.Font = Enum.Font.GothamBold
    saveWebhookBtn.ZIndex = 13
    saveWebhookBtn.Parent = mainFrame

    -- Credits
    local credits = Instance.new("TextLabel")
    credits.Text = "üåä Made for Fish It! ‚Ä¢ Delta Executor Compatible üêü"
    credits.Size = UDim2.new(1, 0, 0, 30)
    credits.Position = UDim2.new(0, 0, 1, -40)
    credits.BackgroundTransparency = 1
    credits.TextColor3 = Color3.fromRGB(150, 200, 255)
    credits.Font = Enum.Font.Gotham
    credits.ZIndex = 12
    credits.Parent = mainFrame

    return screenGui, {
        mainFrame = mainFrame,
        statusLabel = statusLabel,
        fishCountLabel = fishCountLabel,
        webhookLabel = webhookLabel,
        toggleBtn = toggleBtn,
        testBtn = testBtn,
        rareToggle = rareToggle,
        closeBtn = closeBtn,
        webhookInput = webhookInput,
        saveWebhookBtn = saveWebhookBtn
    }
end

-- Fish Detection
local fishCount = 0
local lastFishTime = 0

local function getRarity(fishName)
    fishName = fishName:lower()
    for _, secretFish in ipairs(CONFIG.SECRET_FISH_LIST) do
        if fishName:find(secretFish:lower()) then
            return "Secret"
        end
    end
    for _, rareFish in ipairs(CONFIG.RARE_FISH_LIST) do
        if fishName:find(rareFish:lower()) then
            if fishName:find("shark") then return "Shark"
            elseif fishName:find("mythic") then return "Mythic"
            elseif fishName:find("legendary") then return "Legendary"
            elseif fishName:find("epic") then return "Epic"
            else return "Rare"
            end
        end
    end
    return "Common"
end

local function getPlayerLocation()
    if player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
        local pos = player.Character.HumanoidRootPart.Position
        if pos.Y > 50 then return "Spawn Island"
        elseif pos.Y < -20 then return "Deep Ocean"
        else return "Coastal Waters"
        end
    end
    return "Unknown Area"
end

local function setupFishDetection()
    local function monitorGui()
        local function checkNotification(guiElement)
            if not CONFIG.ENABLED then return end
            if guiElement.Name:find("Notification") or guiElement.Name:find("Fish") or guiElement.Name:find("Catch") then
                for _, desc in pairs(guiElement:GetDescendants()) do
                    if desc:IsA("TextLabel") and desc.Text then
                        local text = desc.Text:lower()
                        if text:find("caught") or text:find("fish") or text:find("shark") then
                            local fishName = desc.Text:match("caught (.+)") or desc.Text:match("fish: (.+)") or desc.Text
                            if fishName and fishName ~= "" then
                                local rarity = getRarity(fishName)
                                if CONFIG.RARE_FISH_ONLY and rarity == "Common" then return end
                                if CONFIG.SECRET_FISH_ONLY and rarity ~= "Secret" and rarity ~= "Mythic" then return end
                                local now = tick()
                                if now - lastFishTime < 2 then return end
                                lastFishTime = now
                                fishCount = fishCount + 1
                                local fishData = {
                                    name = fishName,
                                    rarity = rarity,
                                    location = getPlayerLocation(),
                                    rod = "Current Rod",
                                    timestamp = os.date("%H:%M:%S - %d/%m/%Y")
                                }
                                -- Update GUI
                                if _G.FishItGUI and _G.FishItGUI.fishCountLabel then
                                    _G.FishItGUI.fishCountLabel.Text = "üêü Ikan Tertangkap: " .. fishCount
                                end
                                sendWebhook(fishData)
                                StarterGui:SetCore("SendNotification", {
                                    Title = "üé£ Fish It! - Ikan Tertangkap!";
                                    Text = fishName .. " (" .. rarity .. ")";
                                    Duration = CONFIG.NOTIFICATION_DURATION;
                                })
                            end
                        end
                    end
                end
            end
        end
        playerGui.ChildAdded:Connect(checkNotification)
        for _, gui in pairs(playerGui:GetChildren()) do
            checkNotification(gui)
        end
    end

    monitorGui()
end

-- Inisialisasi
local screenGui, guiElements
if CONFIG.SHOW_GUI then
    screenGui, guiElements = createModernGUI()
    _G.FishItGUI = guiElements

    -- Setup Button Functions
    guiElements.toggleBtn.MouseButton1Click:Connect(function()
        CONFIG.ENABLED = not CONFIG.ENABLED
        guiElements.toggleBtn.Text = CONFIG.ENABLED and "‚è∏Ô∏è Matikan" or "‚ñ∂Ô∏è Aktifkan"
        guiElements.toggleBtn.BackgroundColor3 = CONFIG.ENABLED and Color3.fromRGB(255, 100, 100) or Color3.fromRGB(100, 255, 100)
        guiElements.statusLabel.Text = "Status: " .. (CONFIG.ENABLED and "üü¢ Aktif" or "üî¥ Nonaktif")
        guiElements.statusLabel.TextColor3 = CONFIG.ENABLED and Color3.fromRGB(80, 255, 80) or Color3.fromRGB(255, 80, 80)
    end)

    guiElements.testBtn.MouseButton1Click:Connect(function()
        local testData = {
            name = "Test Megalodon ü¶à",
            rarity = "Mythic",
            location = "Deep Ocean",
            rod = "Legendary Rod",
            timestamp = os.date("%H:%M:%S - %d/%m/%Y")
        }
        if sendWebhook(testData) then
            StarterGui:SetCore("SendNotification", {
                Title = "‚úÖ Test Berhasil";
                Text = "Cek Discord Anda!";
                Duration = 3;
            })
        end
    end)

    guiElements.rareToggle.MouseButton1Click:Connect(function()
        CONFIG.RARE_FISH_ONLY = not CONFIG.RARE_FISH_ONLY
        guiElements.rareToggle.Text = "ü¶à " .. (CONFIG.RARE_FISH_ONLY and "Semua Ikan" or "Hanya Rare/Shark")
        guiElements.rareToggle.BackgroundColor3 = CONFIG.RARE_FISH_ONLY and Color3.fromRGB(255, 165, 0) or Color3.fromRGB(70, 130, 180)
    end)

    guiElements.closeBtn.MouseButton1Click:Connect(function()
        screenGui:Destroy()
        _G.FishItGUI = nil
    end)

    guiElements.saveWebhookBtn.MouseButton1Click:Connect(function()
        saveWebhookURL(guiElements.webhookInput.Text)
    end)

    guiElements.webhookInput.FocusLost:Connect(function(enterPressed)
        if enterPressed then
            saveWebhookURL(guiElements.webhookInput.Text)
        end
    end)

    -- Drag
    local dragging, dragStart, startPos = false, nil, nil
    local function startDrag(input)
        dragging = true
        dragStart = input.Position
        startPos = guiElements.mainFrame.Position
    end
    local function updateDrag(input)
        if dragging and dragStart and _G.FishItGUI and _G.FishItGUI.mainFrame then
            local delta = input.Position - dragStart
            local newPos = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
            _G.FishItGUI.mainFrame.Position = newPos
        end
    end
    local function endDrag()
        dragging = false
    end
    guiElements.mainFrame.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            startDrag(input)
        end
    end)
    guiElements.mainFrame.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement then
            updateDrag(input)
        end
    end)
    guiElements.mainFrame.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            endDrag()
        end
    end)

    -- Animation
    guiElements.mainFrame.Size = UDim2.new(0, 0, 0, 0)
    guiElements.mainFrame.Position = UDim2.new(0.5, 0, 0.5, 0)
    local tween = TweenService:Create(guiElements.mainFrame, TweenInfo.new(0.6, Enum.EasingStyle.Back), {
        Size = UDim2.new(0, 420, 0, 420),
        Position = UDim2.new(0.5, -210, 0.5, -210)
    })
    tween:Play()
end

-- Start
setupFishDetection()

task.spawn(function()
    task.wait(2)
    if CONFIG.WEBHOOK_URL == "" then
        StarterGui:SetCore("SendNotification", {
            Title = "‚ÑπÔ∏è Panduan";
            Text = "Buka GUI, masukkan Webhook URL, lalu klik 'Simpan Webhook'!";
            Duration = 8;
        })
    end
end)

StarterGui:SetCore("SendNotification", {
    Title = "üêü Fish It! Webhook";
    Text = "Script berhasil dimuat! Selamat memancing! üé£";
    Duration = 5;
})

print("====================================")
print("üêü Fish It! Webhook Script - LOADED!")
print("====================================")
print("üéØ Status: " .. (CONFIG.ENABLED and "üü¢ Active" or "üî¥ Inactive"))
print("====================================")